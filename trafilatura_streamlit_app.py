import json
import streamlit as st
import trafilatura
import requests
from requests.exceptions import RequestException

st.set_page_config(page_title="Trafilatura Content Extractor", layout="wide")

st.title("üîó Extrator de T√≠tulo e Texto via Trafilatura")
st.markdown(
    "Cole a URL de qualquer p√°gina p√∫blica. O app far√° o download, limpar√° o HTML e mostrar√° **T√≠tulo** e **Texto** prontos para copiar."
)

# ----------------------------
# Network helpers
# ----------------------------

def fetch_with_fallback(url: str) -> str | None:
    """Tenta baixar a p√°gina com Trafilatura; se falhar, usa requests com um User‚ÄëAgent comum."""
    # 1) Tentativa direta (Trafilatura j√° define um UA pr√≥prio)
    downloaded = trafilatura.fetch_url(url)
    if downloaded:
        return downloaded

    # 2) Fallback manual com requests
    try:
        resp = requests.get(
            url,
            headers={
                "User-Agent": (
                    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                    "AppleWebKit/537.36 (KHTML, like Gecko) "
                    "Chrome/124.0.0.0 Safari/537.36"
                )
            },
            timeout=20,
        )
        if resp.ok:
            return resp.text
    except RequestException:
        pass

    return None


# ----------------------------
# Extraction logic
# ----------------------------

def extract_text(html: str) -> str | None:
    """Extrai texto limpo usando uma cascata de t√©cnicas."""
    # 1) Heur√≠sticas padr√£o (precis√£o)
    text = trafilatura.extract(
        html,
        include_formatting=False,
        include_links=False,
        favor_recall=False,
    )
    if text:
        return text.strip()

    # 2) Heur√≠sticas de recall (mais permissivas)
    text = trafilatura.extract(
        html,
        include_formatting=False,
        include_links=False,
        favor_recall=True,
    )
    if text:
        return text.strip()

    # 3) Readability‚Äëlxml (√∫til para p√°ginas com muito JS ou paywall)
    try:
        from readability import Document  # pip install readability‚Äëlxml

        doc = Document(html)
        main_html = doc.summary(html_partial=True)
        text = trafilatura.html2txt(main_html)
        if text:
            return text.strip()
    except Exception:
        pass

    # 4) Convers√£o bruta HTML‚ÜíTXT (captura tudo)
    try:
        text = trafilatura.html2txt(html)
        if text:
            return text.strip()
    except Exception:
        pass

    # 5) Fallback BeautifulSoup (√∫ltimo recurso, pode trazer lixo)
    try:
        from bs4 import BeautifulSoup  # pip install beautifulsoup4

        soup = BeautifulSoup(html, "html.parser")
        text = soup.get_text("\n", strip=True)
        if text:
            return text
    except Exception:
        pass

    return None


# ----------------------------
# Streamlit UI
# ----------------------------

url = st.text_input("Insira a URL a ser processada:")

if url:
    with st.spinner("‚åõ Baixando e extraindo conte√∫do‚Ä¶"):
        html = fetch_with_fallback(url)
        if not html:
            st.error("‚ùå N√£o foi poss√≠vel baixar a p√°gina. Verifique a URL e tente novamente.")
        else:
            # --------------  T√çTULO  --------------
            title: str | None = None
            try:
                from trafilatura import extract_title  # type: ignore
                title = extract_title(html)
            except Exception:
                pass

            if title is None:
                try:
                    meta = trafilatura.extract_metadata(html)
                    if meta:
                        if isinstance(meta, dict):
                            title = meta.get("title")
                        else:
                            title = getattr(meta, "title", None)
                        if title is None and isinstance(meta, str):
                            meta_dict = json.loads(meta)
                            title = meta_dict.get("title")
                except Exception:
                    pass

            title = title or "T√≠tulo n√£o encontrado"

            # --------------  TEXTO  --------------
            text = extract_text(html) or "Texto n√£o encontrado"

            # --------------  UI  --------------
            st.success("‚úÖ Conte√∫do extra√≠do com sucesso!")

            st.subheader("T√≠tulo")
            st.code(title, language=None)

            st.subheader("Texto")
            st.code(text, language=None)

            st.caption("Clique no √≠cone de c√≥pia (üìã) no canto superior direito dos blocos para copiar.")

# ----------------------------
#     Como rodar localmente
# ----------------------------
# 1. pip install streamlit trafilatura[all] requests readability‚Äëlxml beautifulsoup4
# 2. streamlit run trafilatura_streamlit_app.py
